<?php

/**
 * Avis_mrisTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class Avis_mrisTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object Avis_mrisTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('Avis_mris');
    }

    public function getAvisByDossierId($intDossierId,$strTypeDossier)
    {
      $q = Doctrine_Query::create()
        -> from ('Avis_mris a')
        -> where('a.'.$strTypeDossier.'_id = ?',$intDossierId)
        -> orderBy('date_avis');

        return $q->execute() ;
    }

    /**
   * Retourne le prochain dossier (par rapport à un dossier courant) du même type (thèse, ere, postdoc)
   * en fonction d'une commission et d'un domaine scientifique
   *
   * @param String $typeDossier le type de dossier (dossier_these, dossier_postdoc, dossier_ere)
   * @param Integer $dossierCourantId Id du dossier courant
   * @param Integer $domaineScId Id du domaine scientifique
   * @param Integer $commissionId id de la commission
   * @author Actimage
   * @return Array Dossier
   */
  public function retrieveDossierSuivantListeCommission($dossierCourantId, $domaineScId, $typeDossier, $commissionId) {


    if ($typeDossier == 'dossier_these'){
      $modelName = 'Dossier_these';
      $statutPropositionDossier = Statut_dossier_theseTable::VALIDE;
    }
    if ($typeDossier == 'dossier_postdoc'){
      $modelName = 'Dossier_postdoc';
      $statutPropositionDossier = Statut_dossier_postdocTable::VALIDE;
    }
    if ($typeDossier == 'dossier_ere'){
      $modelName = 'Dossier_ere';
      $statutPropositionDossier = Statut_dossier_ereTable::VALIDE;
    }

    $boolTrouveDossier = false;
    $objDossierSuivant = null;

    //on cherche la commission
    $objCommission = CommissionTable::getInstance()->findOneById($commissionId);
    $anneeCommission = $objCommission->getDateTimeObject('date_debut')->format('Y');
    $dateCommission = $objCommission->getDateTimeObject('date_debut')->format('Y-m-d');

    $objRequeteDoctrine = Doctrine_Core::getTable($modelName)->createQuery('d')
                    ->where('d.created_at >= ?', $anneeCommission -1 . '-01-01 00:00:00')
                    ->andWhere('d.created_at <= ?', $dateCommission  . ' 00:00:00')
                    ->andWhere('d.est_actif = 1')
                    ->andWhere('d.domaine_scientifique_id = ?', $domaineScId)
                    ->andWhere('d.statut_' . $typeDossier . '_id = ?', $statutPropositionDossier)
                    ->orderBy('d.created_at DESC')
                    ->execute();

    foreach ($objRequeteDoctrine as $dossier) {
      //D'abord on check si dans la boucle précédente on a trouvé le dossier courant
      //puis on retourne le dossier qui est le dossier suivant
      if ($boolTrouveDossier) {
        return $dossier;
        $boolTrouveDossier = false;
      }

      //on check si les ID des 2 dossiers correspondent
      if ($dossier->getId() == $dossierCourantId) {
        $boolTrouveDossier = true;
      }
    }
  }
}