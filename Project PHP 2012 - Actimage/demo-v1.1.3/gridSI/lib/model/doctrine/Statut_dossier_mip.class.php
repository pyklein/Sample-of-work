<?php

/**
 * Statut_dossier_mip
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    gridSI
 * @subpackage model
 * @author     Jihad Sahebdin
 * @version    SVN: $Id: Builder.php 7691 2011-02-04 15:43:29Z jwage $
 */
class Statut_dossier_mip extends BaseStatut_dossier_mip {

  public function __toString() {
    return $this->getIntitule();
  }

  public function getSuivant() {
    return Statut_dossier_mipTable::getInstance()->getNextStatut($this->getId());
  }

  public function save(Doctrine_Connection $conn = null, $immediate = false) {
    if (!sfContext::hasInstance()){
      parent::save();
    }
    if ($immediate) {
      $this->logDebug('Save()  Immediate : '.$this->getIntitule());
      parent::save();
    } else {
      if ($this->isNew()) {
        //récuperation du statut précédent du statut en cours
        $objStatutPrecedent = $this->getPrecedent();

        //cas insertion à la racine
        if ($objStatutPrecedent->getId() == null) {
          $objStatutSuivant = Statut_dossier_mipTable::getInstance()->findRoot();
          //cas Premier Statut enregistré
          if ($objStatutSuivant === false) {
            $this->logDebug('Save()  Premier statut (new) :'.$this->getIntitule());
            parent::save();
          } else {
            //cas insertion devant un autre à la racine
            $this->setPrecedent(null);
             $this->logDebug('Save()  Insertion racine (new) :'.$this->getIntitule());
            parent::save();
            $objStatutSuivant->setPrecedentStatutDossierMipId($this->getId());
            $objStatutSuivant->save(null, true);
          }
        } else {
          $objStatutSuivant = $objStatutPrecedent->getSuivant();
          //cas insertion à la fin
          if ($objStatutSuivant === false) {
             $this->logDebug('Save()  Insertion fin (new) :'.$this->getIntitule());
            parent::save();
          } else {
             $this->logDebug('Save()  Insertion milieu (new) :'.$this->getIntitule());
            parent::save();
            $objStatutSuivant->setPrecedent($this);
            $objStatutSuivant->save(null, true);
            ;
          }
        }
      } else {
        $arrChampsModifies = $this->getModified(true);
        //cas activation/désactivation ou changement de libelle
        if (!array_key_exists('precedent_statut_dossier_mip_id', $arrChampsModifies)) {
           $this->logDebug('Save()  Modification autre :'.$this->getIntitule());
          parent::save();
        } else {
          //recupération ancien précedent
          $strAncienPrecedentId = $arrChampsModifies['precedent_statut_dossier_mip_id'];
          //récupération ancien suivant
          $intAncienSuivantId = $this->getSuivant() != false ? $this->getSuivant()->getId() : null;


          //liaison ancien suivant -> ancien précedent
          if ($intAncienSuivantId != null) {
            $objAncienSuivant = Statut_dossier_mipTable::getInstance()->findOneById($intAncienSuivantId);
            $objAncienSuivant->setPrecedentStatutDossierMipId($strAncienPrecedentId);
            $objAncienSuivant->save(null, true);
          }

          $intStatutPrecedentId = $this->getPrecedentStatutDossierMipId();

          //réinsertion de notre objet à enregistrer
          //cas insertion à la racine
          if ($intStatutPrecedentId == null) {
            $objStatutSuivant = Statut_dossier_mipTable::getInstance()->findRoot();
            //cas Premier Statut enregistré
            if ($objStatutSuivant === false) {
               $this->logDebug('Save()  Premier statut :'.$this->getIntitule());
              parent::save();
            } else {
              //cas insertion devant un autre à la racine
              $this->setPrecedent(null);
               $this->logDebug('Save()  Insertion racine :'.$this->getIntitule());
              parent::save();
              $objStatutSuivant->setPrecedentStatutDossierMipId($this->getId());
              $objStatutSuivant->save(null, true);
            }
          } else {
            $objStatutSuivant = Statut_dossier_mipTable::getInstance()->getNextStatut($intStatutPrecedentId);
            //cas insertion à la fin
            if ($objStatutSuivant === false) {
               $this->logDebug('Save()  Insertion fin :'.$this->getIntitule());
              parent::save();
              return;
            } else {
               $this->logDebug('Save()  Insertion milieu :'.$this->getIntitule());
              parent::save();
              $objStatutSuivant->setPrecedent($this);
              $objStatutSuivant->save(null, true);
              ;
            }
          }
        }
      }
    }
  }

}