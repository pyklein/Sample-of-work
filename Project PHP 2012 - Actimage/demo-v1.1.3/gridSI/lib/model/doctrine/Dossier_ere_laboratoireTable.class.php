<?php

/**
 * Dossier_ere_laboratoireTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class Dossier_ere_laboratoireTable extends Doctrine_Table {

  /**
   * Returns an instance of this class.
   *
   * @return object Dossier_ere_laboratoireTable
   */
  public static function getInstance() {
    return Doctrine_Core::getTable('Dossier_ere_laboratoire');
  }

  /**
   * Retourne dans une Doctrine_Collection les laboratoires
   * @author Alexandre WETTA
   */
  public function getLaboratoiresDossier() {
    $objRequeteDoctrine = $this->createQuery();

    $arrDossiersLabo = $objRequeteDoctrine->execute();
    $arrLaboratoires = array();
    $arrDossiersCanon = new Doctrine_Collection('Dossier_ere_laboratoire');

    //recupération des laboratoires et ajout dans la liste des laboratoires
    foreach ($arrDossiersLabo as $objDossierLabo) {
      $labo = $objDossierLabo->getLaboratoireId();
      if (!in_array($labo, $arrLaboratoires)) {
        $arrLaboratoires[] = $labo;
        $arrDossiersCanon->add($objDossierLabo);
      }
    }
    return $arrDossiersCanon;
  }

  /**
   * Retourne un tableau de dossier ID en fonction d'une région
   * @param int $regionId Id de la région
   * @return array Tableau de dossier Id
   * @author Alexandre WETTA
   */
  public function retrieveDossierEreByRegion($regionId) {

    //recherche des villes de la région
    $queryVilleDansRegion = VilleTable::getInstance()->retrieveVilleParRegion($regionId);

    //check s'il y a des villes dans la région spécifiée
    if ($queryVilleDansRegion->count() != 0) {
      $arrVilleDansRegion = $queryVilleDansRegion->execute();
      $arrVilleDansRegionId = array();
      foreach ($arrVilleDansRegion as $objVille) {
        $arrVilleDansRegionId[] = $objVille->getId();
      }

      //recherche des pts de contacts avec metier MRIS et en fonction des villes de la région spécifiée
      $queryPtsContact = Point_contactTable::getInstance()->retrievePtsContactMrisFiltreParVille($arrVilleDansRegionId);

      //check si on a trouvé des pts de contact
      if ($queryPtsContact->count() != 0) {
        $arrPtsContact = $queryPtsContact->execute();
        $arrPtsContactLaboId = array();
        foreach ($arrPtsContact as $objPtsContact) {
          $arrPtsContactLaboId[] = $objPtsContact->getLaboratoireId();
        }
        $queryDossierLabo = $this->createQuery('d')->whereIn('d.laboratoire_id', $arrPtsContactLaboId);

        //on vérifie qu'il y a des objets
        if ($queryDossierLabo->count()) {

          $arrDossierLabo = $queryDossierLabo->execute();
          $arrDossierId = array();
          foreach ($arrDossierLabo as $objDossierLabo) {
            $arrDossierId[] = $objDossierLabo->getDossierEreId();
          }

          return $arrDossierId;
        }
      }
    }

    return null;
  }

}