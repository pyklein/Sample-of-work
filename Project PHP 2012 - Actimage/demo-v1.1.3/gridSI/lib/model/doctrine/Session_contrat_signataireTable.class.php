<?php

/**
 * Session_contrat_signataireTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class Session_contrat_signataireTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object Session_contrat_signataireTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('Session_contrat_signataire');
    }

  /**
   * Recharche l'existance d'un couple (ou triplet) de token de transaction et id
   * organisme (et id contrat) dans la table de session
   *
   * @param String $strTransactionToken Token de la session
   * @param String $strIdOrganisme Id de l'organisme vis-à-vis la base de données
   * @param String $strIdContrat Id du contrat vis-à-vis la base de données
   * @return boolean
   *
   * @author Simeon PETEV
   */
  public function isExists($strTransactionToken,$strIdOrganisme,$strIdContrat='')
  {
    if (sfContext::hasInstance())
      sfContext::getInstance()->getLogger()->debug("{".__CLASS__."} [".__FUNCTION__."] /Ligne: ".__LINE__."/ DEBUT; ");

    $objQuery = $this->getInstance()->getQueryObject()
                                        ->where('transaction_token = ?',$strTransactionToken)
                                        ->addWhere('organisme_id = ?',$strIdOrganisme);

    if ($strIdContrat != '')
    {
      $objQuery = $objQuery->addWhere('contrat_id = ?',$strIdContrat);
    }

    if (sfContext::hasInstance())
      sfContext::getInstance()->getLogger()->debug("{".__CLASS__."} [".__FUNCTION__."] /Ligne: ".__LINE__."/ FIN; ");

    return ($objQuery->count()>0) ? true : false;
  }

  /**
   * Efface les entres liées a ce token et retourne true si trout va bien
   *
   * @param String $strToken Le token de la transaction
   * @return boolean
   *
   * @author Simeon PETEV
   */
  public function netoyerSessionParToken($strToken)
  {
    if (sfContext::hasInstance())
      sfContext::getInstance()->getLogger()->debug("{".__CLASS__."} [".__FUNCTION__."] /Ligne: ".__LINE__."/ DEBUT; ");

    $objQuery = $this->getInstance()->getQueryObject()->where('transaction_token = ?',$strToken)->delete();

    try {
      $objQuery->execute();

      if (sfContext::hasInstance())
        sfContext::getInstance()->getLogger()->debug("{".__CLASS__."} [".__FUNCTION__."] /Ligne: ".__LINE__."/ FIN Apres netoyage de table de session avec token - ".$strToken."; ");

      return true;
    } catch (Exception $exc) {
      if (sfContext::hasInstance())
        sfContext::getInstance()->getLogger()->debug("{".__CLASS__."} [".__FUNCTION__."] /Ligne: ".__LINE__."/ FIN Apres echec de netoyage de table de session avec token - ".$strToken."; ");

      return false;
    }
  }
}